<!DOCTYPE html>
<html style="font-size: 100px;">
<head>
	<title>鸿鸡</title>
	<link rel="shortcut icon" href="favicon.ico">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
</head>
<style type="text/css">
	* {margin: 0; padding: 0; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
	body{font: 400 0.12rem 'Open Sans'; color: #333; background-color: #f5f5f5; width: 100%;}
	.tc{text-align: center;}
	.mt10{margin-top: 0.1rem;}
	.pd10{padding: 0.1rem;}
	.hide{display: none;}
	ul > li {list-style:none;}
	th,td {text-align: left;}
	.flex{display: flex;}
	.flex-l{margin-right: auto;}
	.flex-r{margin-left: auto;}
	img{width: .20rem;height: .20rem;}
	h3 {line-height: .20rem;}
	.f14{font-size: .14rem;}
	.orange{color: orange;}
	button {padding: 0.03rem 0.05rem;}
	#add-btn{position: absolute;top: .50rem; right: .20rem;}
	#update-btn{position: absolute;top: .50rem; right: .65rem;}
	.modal .mask {position: fixed;height: 100%;width: 100%;background: #000;opacity: 0.7;top: 0;left: 0}
	.modal .modal-body {background: #fff; height: 3rem;left: 0.16rem;width: calc(100% - 0.32rem);position: fixed;top: calc(50% - 1.5rem);border-radius: 0.05rem;}
	.modal .modal-title {height: 0.4rem;line-height: 0.4rem;border-bottom: 0.01rem solid #ccc;font-weight: 600;font-size: 0.16rem;text-align: center;}
	input {width: 100%;height: 30px;line-height: 30px;margin-top: 5px;padding: 0 0.1rem;}
	.input-item label {font-size: 0.14rem;}
	.modal button {width: 44%;height: 0.3rem;line-height: 0.2rem;}
</style>
<body>
	<div id="fundapp">
		<div class="flex" style="margin-top: 0.5rem;">
			<h3 class="flex-r f14">鸿</h3>
			&nbsp;&nbsp;&nbsp;
			<img class="flex-l" src="logo.png">
			<button type="button" id="add-btn">新增</button>
		</div>
		<div class="pd10 mt10">
			<table width="100%" id="fund-table">
				<thead>
					<tr>
						<th>名称</th>
						<th>代码</th>
						<th>涨幅</th>
						<th>净值</th>
						<th>估值</th>
					</tr>
				</thead>
				<tbody>

				</tbody>
			</table>
			<div class="modal hide" id="modal">
		        <div class="mask"></div>
		        <div class="modal-body">
		        	<div class="modal-title">
		        		新增基金
		        	</div>
		        	<form style="padding: 0.3rem 0.2rem;">
		        		<div class="input-item">
		        			<label>代码</label>
		        			<input type="text" name="code" id="code" placeholder="请输入基金代码" autocomplete="off" maxlength="6">
		        		</div>
		        		<div class="flex" style="margin-top: 0.5rem;">
		        			<button class="flex-l" type="button" id="cancel-btn">取消</button>
		        			<button class="flex-r" type="button" id="confirm-btn">确定</button>
		        		</div>
		        	</form>
		        </div>
		    </div>
		</div>
	</div>
</body>
<script type="text/javascript">
//缩放界面后重新设定html font size
let view_jsset_font, result_font, user_webset_font, clientWidth;
if(document.documentElement.currentStyle) {
    user_webset_font = document.documentElement.currentStyle['fontSize'];
} else {
    user_webset_font = getComputedStyle(document.documentElement,false)['fontSize'];
}
const xs = parseFloat(user_webset_font) / 100;
const docEl = document.documentElement,
    resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
    recalc = function() {
        clientWidth = docEl.clientWidth;
        if (!clientWidth) return;
        if (!document.addEventListener) return;
        view_jsset_font = (clientWidth / 3.75);
        result_font = view_jsset_font / xs;
        docEl.style.fontSize = result_font + 'px';
    };
window.addEventListener(resizeEvt, recalc, false);
recalc();
function ajax(params) {
    params = params || {};
    params.data = params.data || {};
    var json = params.dataType === 'jsonp' ? jsonp(params) : json(params);
    // jsonp请求
    function jsonp(params) {
        //创建script标签并加入到页面中
        const callbackName = params.jsonp ? params.jsonp : 'jsonp_'+random();
        const head = document.getElementsByTagName('head')[0];
        // 设置传递给后台的回调参数名
        params.data['callback'] = callbackName;
        const data = formatParams(params.data);
        const script = document.createElement('script');
        head.appendChild(script);
        //创建jsonp回调函数
        window[callbackName] = function(json) {
            head.removeChild(script);
            clearTimeout(script.timer);
            window[callbackName] = null;
            params.success && params.success(json);
        };
        //发送请求
        script.src = params.url + '?' + data;
        //为了得知此次请求是否成功，设置超时处理
        if(params.time) {
            script.timer = setTimeout(function() {
                window[callbackName] = null;
                head.removeChild(script);
                params.error && params.error({
                    message: '超时'
                });
            }, time);
        }
    };
    //普通json请求
    function json(params) {   
        params.type = (params.type || 'GET').toUpperCase();
        params.data = formatParams(params.data);
        var xhr = null;
        if(window.XMLHttpRequest) {
            xhr = new XMLHttpRequest();
        } else {
            xhr = new ActiveXObjcet('Microsoft.XMLHTTP');
        };
        xhr.onreadystatechange = function() {
            if(xhr.readyState == 4) {
                var status = xhr.status;
                if(status >= 200 && status < 300) {
                    var response = '';
                    var type = xhr.getResponseHeader('Content-type');
                    if(type.indexOf('xml') !== -1 && xhr.responseXML) {
                    response = xhr.responseXML; //Document对象响应
                } else if(type === 'application/json') {
                    response = JSON.parse(xhr.responseText); //JSON响应
                } else {
                    response = xhr.responseText; //字符串响应
                };
                    params.success && params.success(response);
                } else {
                    params.error && params.error(status);
                }
            };
        };
        //请求方式，默认是GET
        if(params.type == 'GET') {
            xhr.open(params.type, params.url + '?' + params.data, true);
            xhr.send(null);
        } else {
            xhr.open(params.type, params.url, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
            xhr.send(params.data);
        }
    }
    //格式化参数方法
    function formatParams(data) {
        var arr = [];
        for(var name in data) {
          arr.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
        };
        // 添加一个随机数，防止缓存   
        arr.push('v=' + random());
        return arr.join('&');   
    }
    // 获取随机数方法 
    function random() {
        return Math.floor(Math.random() * 10000 + 500);
    }
}
function jsonpgz(data) {
	console.log(data)
}
const main = {
	init: function(){
		const _this = this;
		//增加按钮
		document.getElementById('add-btn').onclick = function(e){
			const modalObj = document.getElementById('modal');
			const style = window.getComputedStyle(modalObj)
			if (style.display !== 'block') {
				modalObj.style.display = 'block';
			}
		}
		//取消按钮
		document.getElementById('cancel-btn').onclick = function(e){
			document.getElementById('modal').style.display = 'none';
		}
		//确定按钮
		document.getElementById('confirm-btn').onclick = function(e){
			const name = document.getElementById('code').value;
			if (name === '') {
				document.getElementById('code').focus();
				return false;
			}
			_this.addCache(name, {});
			document.getElementById('modal').style.display = 'none';
		}
		_this.start();
	},
	getCache: function() {
		let data = localStorage.getItem('my_hongji_cache');
		if (data) {
			data = JSON.parse(data)
		} else {
			data = {};
		}
		return data;
	},
	addCache: function(id, value) {
		let data = this.getCache();
		data[id] = value;
		localStorage.setItem('my_hongji_cache', JSON.stringify(data));
		return true;
	},
	start: function() {
		const _this = this;
		clearInterval(_this.setInterval);
		_this.getData(function(){
			_this.initPage();
		});
		_this.setInterval = setInterval(function(){
			_this.getData(function(){
				_this.initPage();
			});
		}, 2000);
	},
	getData: function(callback) {
		const _this = this;
		const data = _this.getCache();
		let url = '';
		for (const i in data) {
			url = 'http://fundgz.1234567.com.cn/js/'+i+'.js?rt'+(new Date().getTime());
			ajax({
				url: url, 
				dataType: 'jsonp', 
				jsonp: 'jsonpgz',
				success:function(res){
					_this.addCache(res.fundcode, res);
				}
			});
		}
		callback();
	},
	initPage: function() {
		const data = this.getCache();
		let html = '';
		for (const i in data) {
			html += '<tr>';
			html += '<td>'+data[i].name+'</td>';
			html += '<td>'+data[i].fundcode+'</td>';
			html += '<td>'+data[i].gszzl+'</td>';
			html += '<td>'+data[i].dwjz+'</td>';
			html += '<td>'+data[i].gsz+'</td>';
			html += '</tr>';
		}
		document.querySelector('#fund-table tbody').innerHTML = html;
	}
};
main.init();
//页面加载完成
document.onload = function() {
	main.init();
}
</script>
</html>